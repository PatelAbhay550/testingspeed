// Load location on page load
async function loadLocation(){const e=document.getElementById("locationInfo");try{const t=await fetch("/api/location"),n=await t.json();if(n.success&&n.location){const t=n.location;e.innerHTML=`<div style="display: grid; gap: 12px; text-align: left;"><div style="font-weight: 600; font-size: 15px; text-align: center; padding-bottom: 8px; border-bottom: 1px solid #e5e7eb;">üìç Your Location</div><div style="display: flex; align-items: center; gap: 8px;"><span style="font-size: 18px;">üåç</span><span><strong>Location:</strong> ${t.city||"Unknown"}, ${t.region||""} ${t.country||""}</span></div><div style="display: flex; align-items: center; gap: 8px;"><span style="font-size: 18px;">üì∂</span><span><strong>ISP:</strong> ${t.isp||"Unknown"}</span></div><div style="display: flex; align-items: center; gap: 8px;"><span style="font-size: 18px;">üïê</span><span><strong>Timezone:</strong> ${t.timezone||"Unknown"}</span></div><div style="display: flex; align-items: center; gap: 8px;"><span style="font-size: 18px;">üåê</span><span><strong>IP:</strong> ${t.ip||"Unknown"}</span></div></div>`}else e.innerHTML="<div>üìç Location unavailable</div>"}catch(t){e.innerHTML="<div>üìç Could not load location</div>"}}window.addEventListener("DOMContentLoaded",loadLocation);

// Chart drawing functions
let chartData=[];let uploadChartData=[];let chart=null;let isUploadTest=false;function initChart(){const e=document.getElementById("speedChart"),t=document.getElementById("chartContainer");t.classList.add("active");const n=e.getContext("2d");e.width=e.offsetWidth*window.devicePixelRatio;e.height=150*window.devicePixelRatio;n.scale(window.devicePixelRatio,window.devicePixelRatio);chart={canvas:e,ctx:n,width:e.offsetWidth,height:150};chartData=[];uploadChartData=[]}function drawChart(){if(!chart)return;const e=chart.ctx,t=chart.width,n=chart.height,a=isUploadTest?uploadChartData:chartData;e.clearRect(0,0,t,n);if(a.length<2)return;const d=Math.max(...a,10),s=40,i=20,o=10,r=10,l=t-s-r,c=n-i-o;e.strokeStyle="#e5e7eb";e.lineWidth=1;for(let a=0;a<=4;a++){const d=i+c/4*a;e.beginPath();e.moveTo(s,d);e.lineTo(s+l,d);e.stroke()}e.fillStyle="#9ca3af";e.font="10px sans-serif";e.textAlign="right";for(let t=0;t<=4;t++){const n=d*(1-t/4);e.fillText(n.toFixed(1),s-5,i+c/4*t+3)}const g=e.createLinearGradient(0,0,t,0);isUploadTest?(g.addColorStop(0,"#10b981"),g.addColorStop(1,"#059669")):(g.addColorStop(0,"#667eea"),g.addColorStop(1,"#764ba2"));e.strokeStyle=g;e.lineWidth=3;e.beginPath();a.forEach(((t,n)=>{const o=s+n/(a.length-1)*l,r=i+c-t/d*c;0===n?e.moveTo(o,r):e.lineTo(o,r)}));e.stroke();const u=e.createLinearGradient(0,i,0,i+c);isUploadTest?(u.addColorStop(0,"rgba(16, 185, 129, 0.2)"),u.addColorStop(1,"rgba(16, 185, 129, 0.02)")):(u.addColorStop(0,"rgba(102, 126, 234, 0.3)"),u.addColorStop(1,"rgba(118, 75, 162, 0.05)"));e.fillStyle=u;e.beginPath();e.moveTo(s,i+c);a.forEach(((t,n)=>{const o=s+n/(a.length-1)*l,r=i+c-t/d*c;e.lineTo(o,r)}));e.lineTo(s+l,i+c);e.closePath();e.fill()}function updateStats(e=false){const t=e?uploadChartData:chartData;if(t.length===0)return;const n=Math.min(...t),a=t.reduce(((e,t)=>e+t),0)/t.length,d=Math.max(...t);if(e){document.getElementById("minUploadSpeed").textContent=n.toFixed(1);document.getElementById("avgUploadSpeed").textContent=a.toFixed(1);document.getElementById("maxUploadSpeed").textContent=d.toFixed(1);document.getElementById("uploadStats").style.display="block"}else{document.getElementById("minSpeed").textContent=n.toFixed(1);document.getElementById("avgSpeed").textContent=a.toFixed(1);document.getElementById("maxSpeed").textContent=d.toFixed(1)}}

// Speed test function
async function runTest(){const e=document.getElementById("testBtn"),t=document.getElementById("downloadSpeed"),n=document.getElementById("uploadSpeed"),a=document.getElementById("status"),d=document.getElementById("downloadBox"),s=document.getElementById("uploadBox");e.disabled=!0,t.textContent="0.00",n.textContent="0.00",a.textContent="Testing download...",a.className="status",d.classList.add("active"),s.classList.remove("active"),isUploadTest=false,initChart();try{const e="https://speed.cloudflare.com/__down?bytes=25000000";let n=0;const s=Date.now();let i=s,o=0;for(let t=0;t<3;t++){const t=await fetch(e),a=t.body.getReader();for(;;){const{done:e,value:t}=await a.read();if(e)break;n+=t.length;const s=Date.now();if(s-i>200){const e=(s-i)/1e3,a=n-o,d=8*a/(1e6*e);chartData.push(d),drawChart(),updateStats(false),i=s,o=n}}}const r=chartData.reduce(((e,t)=>e+t),0)/chartData.length;t.textContent=r.toFixed(2),drawChart(),updateStats(false),d.classList.remove("active"),await testUpload()}catch(e){t.textContent="0.00",n.textContent="0.00",a.textContent="Error: "+e.message,a.className="status error"}finally{e.disabled=!1}}async function testUpload(){const e=document.getElementById("uploadSpeed"),t=document.getElementById("status"),n=document.getElementById("uploadBox");n.classList.add("active"),t.textContent="Testing upload...",isUploadTest=true,uploadChartData=[];try{const a=new ArrayBuffer(5242880);let d=0;const s=Date.now();for(let t=0;t<5;t++){const t=Date.now(),n=await fetch("https://httpbin.org/post",{method:"POST",body:a,headers:{"Content-Type":"application/octet-stream"}});await n.text();const i=Date.now()-t;if(i>0){const t=41943040/i/1e3;uploadChartData.push(t),d+=5242880,e.textContent=t.toFixed(2),drawChart(),updateStats(true)}if(Date.now()-s>12e3)break}const i=uploadChartData.reduce(((e,t)=>e+t),0)/uploadChartData.length;e.textContent=i.toFixed(2),drawChart(),updateStats(true),t.textContent="Test complete",n.classList.remove("active")}catch(a){e.textContent="0.00",t.textContent="Upload test failed",console.error(a)}}

// Service Worker registration
"serviceWorker"in navigator&&window.addEventListener("load",(()=>{navigator.serviceWorker.register("/public/sw.js").then((e=>console.log("SW registered"))).catch((e=>console.log("SW registration failed")))}));