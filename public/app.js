// Load location on page load
async function loadLocation(){const e=document.getElementById("locationInfo");try{const t=await fetch("/api/location"),n=await t.json();if(n.success&&n.location){const t=n.location;e.innerHTML=`<div style="display: grid; gap: 12px; text-align: left;"><div style="font-weight: 600; font-size: 15px; text-align: center; padding-bottom: 8px; border-bottom: 1px solid #e5e7eb;">üìç Your Location</div><div style="display: flex; align-items: center; gap: 8px;"><span style="font-size: 18px;">üåç</span><span><strong>Location:</strong> ${t.city||"Unknown"}, ${t.region||""} ${t.country||""}</span></div><div style="display: flex; align-items: center; gap: 8px;"><span style="font-size: 18px;">üì∂</span><span><strong>ISP:</strong> ${t.isp||"Unknown"}</span></div><div style="display: flex; align-items: center; gap: 8px;"><span style="font-size: 18px;">üïê</span><span><strong>Timezone:</strong> ${t.timezone||"Unknown"}</span></div><div style="display: flex; align-items: center; gap: 8px;"><span style="font-size: 18px;">üåê</span><span><strong>IP:</strong> ${t.ip||"Unknown"}</span></div></div>`}else e.innerHTML="<div>üìç Location unavailable</div>"}catch(t){e.innerHTML="<div>üìç Could not load location</div>"}}window.addEventListener("DOMContentLoaded",loadLocation);

// Chart drawing functions
let chartData=[];let chart=null;function initChart(){const e=document.getElementById("speedChart"),t=document.getElementById("chartContainer");t.classList.add("active");const n=e.getContext("2d");e.width=e.offsetWidth*window.devicePixelRatio;e.height=150*window.devicePixelRatio;n.scale(window.devicePixelRatio,window.devicePixelRatio);chart={canvas:e,ctx:n,width:e.offsetWidth,height:150};chartData=[]}function drawChart(){if(!chart)return;const e=chart.ctx,t=chart.width,n=chart.height,a=chartData;e.clearRect(0,0,t,n);if(a.length<2)return;const d=Math.max(...a,10),s=40,i=20,o=10,r=10,l=t-s-r,c=n-i-o;e.strokeStyle="#e5e7eb";e.lineWidth=1;for(let a=0;a<=4;a++){const d=i+c/4*a;e.beginPath();e.moveTo(s,d);e.lineTo(s+l,d);e.stroke()}e.fillStyle="#9ca3af";e.font="10px sans-serif";e.textAlign="right";for(let t=0;t<=4;t++){const n=d*(1-t/4);e.fillText(n.toFixed(1),s-5,i+c/4*t+3)}e.strokeStyle="#2563eb";e.lineWidth=2;e.beginPath();a.forEach(((t,n)=>{const o=s+n/(a.length-1)*l,r=i+c-t/d*c;0===n?e.moveTo(o,r):e.lineTo(o,r)}));e.stroke();e.fillStyle="rgba(37, 99, 235, 0.1)";e.beginPath();e.moveTo(s,i+c);a.forEach(((t,n)=>{const o=s+n/(a.length-1)*l,r=i+c-t/d*c;e.lineTo(o,r)}));e.lineTo(s+l,i+c);e.closePath();e.fill()}function updateStats(){if(chartData.length===0)return;const e=Math.min(...chartData),t=chartData.reduce(((e,t)=>e+t),0)/chartData.length,n=Math.max(...chartData);document.getElementById("minSpeed").textContent=e.toFixed(1);document.getElementById("avgSpeed").textContent=t.toFixed(1);document.getElementById("maxSpeed").textContent=n.toFixed(1)}

// Speed test function
async function runTest(){const e=document.getElementById("testBtn"),t=document.getElementById("speed"),n=document.getElementById("status");e.disabled=!0,t.textContent="0.00",n.textContent="Testing...",n.className="status",initChart();try{const a="https://speed.cloudflare.com/__down?bytes=25000000";let d=0;const s=Date.now();let i=s,o=0;for(let e=0;e<3;e++){const e=await fetch(a),r=e.body.getReader();for(;;){const{done:e,value:a}=await r.read();if(e)break;d+=a.length;const l=Date.now();if(l-i>200){const e=(l-i)/1e3,a=d-o,r=8*a/(1e6*e);t.textContent=r.toFixed(2),chartData.push(r),drawChart(),updateStats(),i=l,o=d}}}const r=(Date.now()-s)/1e3,l=8*d/(1e6*r);t.textContent=l.toFixed(2),chartData.push(l),drawChart(),updateStats(),n.textContent="Test complete"}catch(e){t.textContent="0.00",n.textContent="Error: "+e.message,n.className="status error"}finally{e.disabled=!1}}

// Service Worker registration
"serviceWorker"in navigator&&window.addEventListener("load",(()=>{navigator.serviceWorker.register("/public/sw.js").then((e=>console.log("SW registered"))).catch((e=>console.log("SW registration failed")))}));